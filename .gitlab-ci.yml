# GitLab CI/CD Pipeline for Terraform Infrastructure
stages:
  - build
  - validate
  - security_scan
  - plan
  - apply

variables:
  TF_ROOT: ${CI_PROJECT_DIR}/terraform
  AWS_DEFAULT_REGION: us-west-2
  TERRAFORM_VERSION: "1.5.7"

# Install dependencies and setup Terraform
.setup_template: &setup
  - apt-get update -qq && apt-get install -y -qq curl unzip jq python3 python3-pip
  - curl -sL https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip > /tmp/terraform.zip
  - unzip /tmp/terraform.zip
  - export PATH=$PATH:$(pwd)
  - terraform version
  - terraform init

before_script:
  - *setup

build:
  stage: build
  script:
    - echo "Building infrastructure configuration..."
    - terraform validate
    - terraform fmt -check
    - echo "Build completed successfully"
  artifacts:
    paths:
      - terraform/
    expire_in: 1 hour
  only:
    - merge_requests
    - develop
    - main

validate:
  stage: validate
  script:
    - echo "Validating Terraform configuration..."
    - terraform validate
    - terraform fmt -check
    - echo "Validation completed successfully"
  only:
    - merge_requests
    - develop
    - main

security_scan:
  stage: security_scan
  image: checkmarx/kics:latest
  script:
    - kics scan -p ${TF_ROOT} --report-formats=sarif -o results
    - echo "Security scan completed"
  artifacts:
    paths:
      - results/
    reports:
      sast: results/results.sarif
  only:
    - merge_requests
    - develop
    - main

plan:
  stage: plan
  script:
    - echo "Creating Terraform execution plan..."
    - terraform plan -out=tfplan -var-file="variables/${CI_ENVIRONMENT_NAME}.tfvars" || terraform plan -out=tfplan
    - terraform show -json tfplan > plan.json
    - echo "Plan created successfully"
  artifacts:
    paths:
      - tfplan
      - plan.json
    expire_in: 1 hour
  only:
    - merge_requests
    - develop
    - main

apply:
  stage: apply
  script:
    - echo "Applying Terraform configuration..."
    - terraform apply -auto-approve tfplan
    - echo "Infrastructure deployed successfully"
  when: manual
  only:
    - develop
    - main
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://console.aws.amazon.com/ec2/v2/home?region=${AWS_DEFAULT_REGION}